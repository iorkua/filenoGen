<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV File Number Importer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 24px;
        }

        .container {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 960px;
            padding: 32px 40px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 26px;
            color: #333;
            font-weight: 700;
        }

        .header p {
            color: #666;
            font-size: 14px;
            margin-top: 4px;
        }

        .section {
            margin-top: 24px;
        }

        .section-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .upload-form {
            background: #f8f9ff;
            border: 1px solid #dbe0ff;
            border-radius: 10px;
            padding: 20px;
        }

        .form-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 220px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }

        input[type="file"],
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="file"]:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .upload-actions {
            margin-top: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }

        .upload-actions button {
            padding: 12px 20px;
            border-radius: 6px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .upload-actions button:hover {
            transform: translateY(-1px);
        }

        .hint {
            font-size: 13px;
            color: #555;
        }

        .jobs-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .jobs-table th,
        .jobs-table td {
            padding: 12px;
            font-size: 13px;
            color: #333;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        .jobs-table th {
            background: #f4f6ff;
            font-weight: 600;
        }

        .jobs-table tr:last-child td {
            border-bottom: none;
        }

        .jobs-table tr:hover {
            background: #f9f9ff;
            cursor: pointer;
        }

        .jobs-table tr.active {
            background: #eef0ff;
        }

        .status-pill {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending { background: #fff8e5; color: #946200; }
        .status-queued { background: #e8f4ff; color: #0b5ebf; }
        .status-running { background: #e6ffed; color: #177245; }
        .status-completed { background: #dff5e3; color: #1f7a39; }
        .status-error { background: #fdecea; color: #b02a37; }

        .progress-section {
            margin-top: 24px;
            border-top: 2px solid #f0f0f5;
            padding-top: 24px;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .progress-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }

        .progress-bar-container {
            background: #edf0ff;
            border-radius: 6px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.2s ease;
        }

        .progress-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #666;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            border-left: 4px solid #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 18px;
            color: #333;
            font-weight: 600;
        }

        .log-section {
            margin-top: 18px;
        }

        .log-container {
            background: #f9fafc;
            border: 1px solid #dfe3f0;
            border-radius: 8px;
            height: 220px;
            overflow-y: auto;
            padding: 12px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
        }

        .log-entry {
            margin-bottom: 4px;
            color: #333;
        }

        .log-entry.info { color: #667eea; }
        .log-entry.success { color: #1f7a39; }
        .log-entry.error { color: #b02a37; }
        .log-entry.warning { color: #b88a00; }
        .log-entry.progress { color: #0c7d8c; font-weight: 600; }

        .status-message {
            margin-top: 16px;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            display: none;
        }

        .status-message.active { display: block; }
        .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        .connection-status {
            position: fixed;
            top: 12px;
            right: 12px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .connection-status.connected { background: #d4edda; color: #155724; }
        .connection-status.disconnected { background: #f8d7da; color: #721c24; }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        @media (max-width: 768px) {
            .container { padding: 24px; }
            .form-row { flex-direction: column; }
            .jobs-table { font-size: 12px; }
            .jobs-table th, .jobs-table td { padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connectionStatus">
        <div class="status-dot"></div>
        <span id="connectionText">Disconnected</span>
    </div>

    <div class="container">
        <div class="header">
            <div>
                <h1>ðŸ“Š File Number Importer</h1>
                <p>Queue CSV chunks (â‰¤ 1,000 rows) and monitor progress in real time.</p>
            </div>
        </div>

        <section class="section">
            <div class="section-title">Upload CSV Chunk</div>
            <div class="upload-form">
                <form id="uploadForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="csvUpload">CSV file (max 1,000 rows)</label>
                            <input type="file" id="csvUpload" accept=".csv" required>
                        </div>
                        <div class="form-group">
                            <label for="controlTagInput">Control tag</label>
                            <input type="text" id="controlTagInput" value="PROD" placeholder="e.g., PROD, TEST" required>
                        </div>
                    </div>
                    <div class="upload-actions">
                        <button type="submit">Queue for Import</button>
                        <div class="hint">Tip: split large files into ~1,000 row slices before uploading.</div>
                    </div>
                </form>
            </div>
        </section>

        <section class="section">
            <div class="section-title">Queued Imports</div>
            <table class="jobs-table" id="jobsTable">
                <thead>
                    <tr>
                        <th>Chunk</th>
                        <th>Rows</th>
                        <th>Status</th>
                        <th>Progress</th>
                        <th>Inserted</th>
                        <th>Duplicates</th>
                        <th>Updated</th>
                    </tr>
                </thead>
                <tbody id="jobsTableBody">
                    <tr><td colspan="7" style="text-align:center; padding:18px; color:#777;">No jobs yet. Upload your first chunk.</td></tr>
                </tbody>
            </table>
        </section>

        <section class="progress-section" id="progressSection">
            <div class="progress-header">
                <div>
                    <div class="progress-title" id="progressTitle">Active chunk</div>
                    <div class="hint" id="progressSubtitle"></div>
                </div>
                <div class="progress-meta">
                    <span id="progressPercent">0%</span>
                </div>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Records</div>
                    <div class="stat-value" id="totalRecords">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Inserted</div>
                    <div class="stat-value" id="insertedRecords">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Matched</div>
                    <div class="stat-value" id="matchedRecords">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Unmatched</div>
                    <div class="stat-value" id="unmatchedRecords">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Skipped</div>
                    <div class="stat-value" id="skippedRecords">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Duplicates</div>
                    <div class="stat-value" id="duplicateRecords">0</div>
                </div>
            </div>

            <div class="log-section">
                <div class="section-title">Activity Log</div>
                <div class="log-container" id="logContainer"></div>
            </div>

            <div class="status-message" id="statusMessage"></div>
        </section>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const socket = io();
        let jobs = [];
        let activeJobId = null;
        const jobLogs = {};
        let maxRowsPerFile = 1000;

        function ensureJobLog(jobId) {
            if (!jobLogs[jobId]) {
                jobLogs[jobId] = [];
            }
        }

        function formatDate(value) {
            if (!value) return 'â€”';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return value;
            return date.toLocaleString();
        }

        function formatStatus(status) {
            const map = {
                pending: 'status-pending',
                queued: 'status-queued',
                running: 'status-running',
                completed: 'status-completed',
                error: 'status-error'
            };
            const cls = map[status] || 'status-pending';
            return `<span class="status-pill ${cls}">${status.toUpperCase()}</span>`;
        }

        function detectLogType(message) {
            if (!message) return 'info';
            const lower = message.toLowerCase();
            if (lower.includes('error') || lower.includes('failed')) return 'error';
            if (lower.includes('warning')) return 'warning';
            if (lower.includes('batch') || lower.includes('processing') || lower.includes('inserting')) return 'progress';
            if (lower.includes('complete')) return 'success';
            return 'info';
        }

        function addLog(jobId, message, type = 'info') {
            if (!jobId) {
                return;
            }
            ensureJobLog(jobId);
            const timestamp = new Date().toLocaleTimeString();
            jobLogs[jobId].push({
                message,
                type,
                timestamp
            });

            if (jobLogs[jobId].length > 500) {
                jobLogs[jobId].shift();
            }

            if (jobId === activeJobId) {
                renderLogs(jobId);
            }
        }

        function renderLogs(jobId) {
            const container = document.getElementById('logContainer');
            container.innerHTML = '';
            if (!jobId || !jobLogs[jobId]) {
                container.innerHTML = '<div class="log-entry info">No activity yet.</div>';
                return;
            }

            jobLogs[jobId].forEach(entry => {
                const div = document.createElement('div');
                div.className = `log-entry ${entry.type}`;
                div.textContent = `[${entry.timestamp}] ${entry.message}`;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        function getJobStat(job, key) {
            if (!job || !job.stats) return 0;
            return job.stats[key] || 0;
        }

        function updateProgressSection(job) {
            const section = document.getElementById('progressSection');
            if (!job) {
                section.classList.remove('active');
                return;
            }

            section.classList.add('active');
            document.getElementById('progressTitle').textContent = job.original_name;
            document.getElementById('progressSubtitle').textContent = `Control tag: ${job.control_tag} â€¢ Rows: ${job.row_count}`;

            const percent = job.progress === null || job.progress === undefined ? 0 : job.progress;
            document.getElementById('progressBar').style.width = `${Math.min(100, Math.max(0, percent))}%`;
            document.getElementById('progressPercent').textContent = `${percent ? percent.toFixed(1) : 0}%`;

            const stats = job.stats || {};
            document.getElementById('totalRecords').textContent = (stats.total_records || job.row_count || 0).toLocaleString();
            document.getElementById('insertedRecords').textContent = (stats.inserted_records || 0).toLocaleString();
            document.getElementById('matchedRecords').textContent = (stats.matched_records || 0).toLocaleString();
            document.getElementById('unmatchedRecords').textContent = (stats.unmatched_records || 0).toLocaleString();
            document.getElementById('skippedRecords').textContent = (stats.skipped_records || 0).toLocaleString();
            document.getElementById('duplicateRecords').textContent = (stats.duplicate_records || 0).toLocaleString();

            renderLogs(job.id);
        }

        function renderJobsTable() {
            const tbody = document.getElementById('jobsTableBody');
            tbody.innerHTML = '';

            if (!jobs.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:18px; color:#777;">No jobs yet. Upload your first chunk.</td></tr>';
                return;
            }

            jobs.forEach(job => {
                ensureJobLog(job.id);
                const tr = document.createElement('tr');
                if (job.id === activeJobId) {
                    tr.classList.add('active');
                }
                tr.dataset.jobId = job.id;
                tr.innerHTML = `
                    <td>${job.original_name}</td>
                    <td>${job.row_count.toLocaleString()}</td>
                    <td>${formatStatus(job.status)}</td>
                    <td>${job.progress !== null && job.progress !== undefined ? job.progress.toFixed(1) + '%' : 'â€”'}</td>
                    <td>${getJobStat(job, 'inserted_records').toLocaleString()}</td>
                    <td>${getJobStat(job, 'duplicate_records').toLocaleString()}</td>
                    <td>${formatDate(job.updated_at)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function setActiveJob(jobId) {
            activeJobId = jobId;
            renderJobsTable();
            updateProgressSection(jobs.find(job => job.id === jobId));
        }

        function selectBestActiveJob() {
            if (activeJobId && jobs.some(job => job.id === activeJobId)) {
                return;
            }
            const running = jobs.find(job => job.status === 'running');
            const queued = jobs.find(job => job.status === 'queued');
            const pending = jobs.find(job => job.status === 'pending');
            const completed = [...jobs].reverse().find(job => job.status === 'completed');
            const next = running || queued || pending || completed || jobs[0];
            if (next) {
                setActiveJob(next.id);
            } else {
                setActiveJob(null);
            }
        }

        function showMessage(message, type = 'info') {
            const statusMsg = document.getElementById('statusMessage');
            statusMsg.textContent = message;
            statusMsg.className = `status-message status-${type} active`;
            if (type !== 'info') {
                setTimeout(() => {
                    statusMsg.classList.remove('active');
                }, 6000);
            }
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            if (connected) {
                status.className = 'connection-status connected';
                text.textContent = 'Connected';
            } else {
                status.className = 'connection-status disconnected';
                text.textContent = 'Disconnected';
            }
        }

        async function fetchJobs() {
            try {
                const response = await fetch('/api/jobs');
                if (!response.ok) {
                    throw new Error('Failed to load jobs');
                }
                const data = await response.json();
                jobs = data.jobs || [];
                maxRowsPerFile = data.max_rows_per_file || 1000;
                renderJobsTable();
                selectBestActiveJob();
                document.querySelector('.hint').textContent = `Tip: split large files into ~${maxRowsPerFile} row slices before uploading.`;
            } catch (error) {
                showMessage(error.message, 'error');
            }
        }

        document.getElementById('jobsTableBody').addEventListener('click', event => {
            const row = event.target.closest('tr');
            if (!row || !row.dataset.jobId) {
                return;
            }
            setActiveJob(row.dataset.jobId);
        });

        document.getElementById('uploadForm').addEventListener('submit', async event => {
            event.preventDefault();
            const fileInput = document.getElementById('csvUpload');
            const controlTagInput = document.getElementById('controlTagInput');
            if (!fileInput.files.length) {
                showMessage('Please select a CSV file to upload.', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('controlTag', controlTagInput.value.trim() || 'PROD');

            try {
                showMessage('Uploading chunk...', 'info');
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Upload failed');
                }

                const data = await response.json();
                showMessage(`Queued ${data.job.original_name} (${data.job.row_count} rows).`, 'success');
                addLog(data.job.id, 'Job queued for processing.', 'info');
                await fetchJobs();
                fileInput.value = '';
            } catch (error) {
                showMessage(error.message, 'error');
            }
        });

        socket.on('connect', () => {
            updateConnectionStatus(true);
        });

        socket.on('disconnect', () => {
            updateConnectionStatus(false);
        });

        socket.on('jobs_update', data => {
            jobs = data.jobs || [];
            renderJobsTable();
            selectBestActiveJob();
        });

        socket.on('progress', data => {
            const jobId = data.job_id;
            if (!jobId) {
                return;
            }
            const message = data.message || '';
            addLog(jobId, message, detectLogType(message));

            const job = jobs.find(item => item.id === jobId);
            if (job) {
                job.progress = data.progress !== null ? data.progress : job.progress;
                job.last_message = message;
            }

            if (jobId === activeJobId) {
                updateProgressSection(jobs.find(item => item.id === jobId));
            }
        });

        socket.on('import_complete', data => {
            const jobId = data.job_id;
            const success = data.success;
            const message = success
                ? `âœ“ ${data.file_name} imported. Inserted ${data.inserted_records} records (duplicates skipped: ${data.duplicate_records}).`
                : `Import failed for ${data.file_name}.`;
            addLog(jobId, message, success ? 'success' : 'error');
            showMessage(message, success ? 'success' : 'error');
            fetchJobs();
        });

        socket.on('error', data => {
            const message = data.message || 'Server error';
            showMessage(message, 'error');
            if (data.job_id) {
                addLog(data.job_id, message, 'error');
            }
        });

        socket.on('status_update', data => {
            jobs = data.jobs || jobs;
            renderJobsTable();
            selectBestActiveJob();
        });

        fetchJobs();
    </script>
</body>
</html>
